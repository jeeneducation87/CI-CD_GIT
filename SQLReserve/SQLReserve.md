# Домашнее задание к занятию «Резервное копирование баз данных»

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

### Решение 1.

Для финансовой компании критически важны целостность данных и скорость их восстановления (в минутах/часах). Эти задачи описываются двумя параметрами:
- RPO - Recovery Point Objective (Целевая точка восстановления) иными словами сколько данных мы готовы потерять. Максимальный период времени, за который могут быть потеряны данные в случае аварии.
- RTO -  Recovery Time Objective (Целевое время восстановления) иными словами как долго мы можем простаивать.


1. Необходимо восстанавливать данные в полном объёме за предыдущий день

В данном случае подходит полное резервное копирование (Full Backup).
Раз в сутки (обычно ночью, в период минимальной нагрузки, например, в 02:00) создается полная копия всей базы данных.
В случае аварии берем вчерашний файл бэкапа и разворачиваем его. Данные восстанавливаются в том состоянии, в котором они были на момент создания копии (на 02:00 вчерашнего дня).
Самый простой и надежный метод восстановления, но требует много места на диске и времени на создание, если база большая. Данные, накопленные за текущий день до момента аварии, будут потеряны.

2. Необходимо восстанавливать данные за час до предполагаемой поломки

Требуется более частое сохранение изменений. Подходят Дифференциальное (Differential) или Инкрементальное (Incremental) резервное копирование, а также бэкап журналов транзакций.

Раз в сутки делается полный бэкап. Каждый час делается Инкрементальный или Дифференциальный бэкап (копируются только те данные, которые изменились с момента последнего бэкапа).
Максимальная потеря данных составит не более 1 часа (RPO = 1 час).

3. * Возможен ли кейс с моментальным переключением на работающую базу?

Да, но это уже не классическое «резервное копирование» (бэкапы), а механизмы отказоустойчивости (High Availability - HA) и репликации.

Кластеризация базы данных (Master-Slave / Primary-Replica).
Есть основной сервер (Master), который принимает данные. Рядом работает второй сервер (Standby/Replica), на который в реальном времени дублируются (реплицируются) все изменения с основного.
Используется Синхронная репликация: транзакция считается успешной только тогда, когда данные записаны на оба сервера. Это гарантирует, что на втором сервере есть 100% данных.

High Availability.
В момент аварии специальное ПО (Patroni, Pacemaker или облачные балансировщики) обнаруживает, что основной сервер недоступен, и автоматически переключает все запросы на запасной сервер.
Переключение занимает от нескольких секунд до минуты. Потери данных отсутствуют.
Например связка PostgreSQL + Patroni + etcd + Keepalived + HAProxy на сегодняшний день имеет широкое применение.

Итог сценария аварии:

- Мастер падает.
- Ключ в etcd истекает (допустим, через 15 сек).
- Самая свежая реплика захватывает лидерство.
- Patroni на этой реплике выполняет команду promote (превращает её в Мастера).
- HAProxy видит смену ролей (через API) и начинает лить трафик на новый сервер.
- Пользователь замечает «подвисание» на 15-30 секунд, после чего работа продолжается.

Важно отметить, что репликация при всех ее бонусах не заменяет бэкапы. Если кто-то случайно удалит таблицу на основном сервере (DROP TABLE), она мгновенно удалится и на реплике. Поэтому для защиты от ошибок (а не от поломок оборудования) всё равно нужны классические резервные копии.

---

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.2.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

### Решение 2.

1. pgdump/pgrestore стандартные утилиты для создания и восстановления резевных копий в PGSQL.
Стоит отметить что flat sql файлы (обычный текстовый SQL-дамп, Format: plain (-F p)) восстанавливаются через утилиту psql, а не pg_restore.

Стоит выделить два формата резервных копий Format: custom (-F c) и Format: directory (-F d).
В отличие от формата custom, который упаковывает всё в один архивный файл, формат directory создает папку. Внутри этой папки pg_dump создает отдельный сжатый файл для каждой таблицы (или группы объектов) и файл оглавления (toc.dat).
Главное преимущество формата directory: Параллельность (Multithreading).
При использовании -F d можно включить флаг -j (jobs). Это позволяет pg_dump выгружать данные в несколько потоков одновременно, используя разные ядра процессора.
Без -j: Бэкап базы в 500 ГБ может идти 4 часа (работает 1 ядро).
С -j 4: Бэкап той же базы может пройти за 1 час (работают 4 ядра параллельно).

- pg_dump -U postgres -h localhost -F p -f /backup/backup.sql my_database
- pg_dump -U postgres -h localhost -F p my_database | gzip > /backup/backup.sql.gz
Plain (Текстовый SQL) со сжатием и без, восстанвливаем утилитой psql

- pg_dump -U postgres -h localhost -F c -f /backup/backup.dump my_database
Custom (Пользовательский архив), восстанвливаем утилитой pg_restore

- pg_dump -U postgres -h localhost -F d -j 4 -f /backup/backup_folder my_database
Directory (Директория)

2. * Лучшим решением для автоматизации процесса резервного копирования данных являются специализированные приложения, такие как pgBackRest, Wal-G. Данные програамные решения умеют делать инкрементальные бэкапы, отправлять их сразу в облако (S3) и управлять ротацией профессионально.
Также можно написать bash скрипт для создания бекапа и вызывать его через планировщик cron. В данном случае стоит подумать о безопасности хранения пароля например в файле .pgpass в домашней директории пользователя с ограниченными правами. 
Однако данное решение уступает по надежности профессиональным утилитам.

---

### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

3.2.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

### Решение 3.

1.  Стандартная бесплатная утилита mysqldump не умеет делать инкрементальные бэкапы (делает только полные). 
Для работы с резервными копиями можно использовать MySQL Enterprise Backup. Также для бесплатной версии MySQL инкрементное копирование реализуется через архивирование бинарных логов (Binary Logs).

- MySQL Enterprise Backup
```python
mysqlbackup --defaults-file=/etc/my.cnf \
  --incremental \
  --incremental-base=history:last_backup \
  --backup-dir=/var/backup/inc_1 \
  backup
  ```
--incremental: режим инкрементного копирования
--incremental-base=history:last_backup: указывает утилите найти в истории последний успешный бэкап и скопировать только изменения, произошедшие после него
--backup-dir: путь, куда сохранить новые файлы

- Бинарные логи (Community edition)
Так как утилита mysqldump не умеет делать инкрементные бэкапы, то делаем полный бэкап, а «инкрементом» будут файлы логов, в которые записываются все изменения данных.

Чтобы зафиксировать инкремент (отделить старые логи от новых), используется команда flush-logs.
Команда для создания «отсечки» (ротации логов):
```python
mysqladmin -u root -p flush-logs
```
Пример:
Выполняется команда flush-logs.
Сервер закрывает текущий файл лога (binlog.000001) и начинает писать в новый (binlog.000002).
Файл binlog.000001 теперь является инкрементным бэкапом.
Процедуру можно автоматизировать.

2. *  Использование репликации дает преимущества перед обычным резервным копированием в сценариях, где критически важны скорость восстановления работы (RTO), актуальность данных (RPO) и производительность. Требование высокой доступности (High Availability / Failover) - в данном случае реплика это уже развернутая и работающая копия. Мы просто переключаем приложение на адрес реплики (Promote to Master).

Масштабирование нагрузки (Load Balancing) также можно отнести к преимуществам резервного копирования.
Можно настроить приложение так, чтобы все запросы на запись шли на Мастера, а запросы на чтение распределялись между несколькими Репликами. Это повышает производительность системы.

Тяжелая аналитика и отчеты, а также тестирование чего либо на боевых данных хорошо делать на реплике, так как это и позволит провести работы и распределить нагрузку не затронув мастер.

Однако на практике применяется и резервное копирование и репликация, оба подхода дополняют друг друга и хорошо комбинируются. Репликация не заменяет резервное копирование. 
Реплика — от аппаратных сбоев и для скорости работы.
Бэкап — от человеческих ошибок и логического повреждения данных.

---
